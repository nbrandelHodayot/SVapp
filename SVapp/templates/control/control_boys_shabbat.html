{% extends "control/control_base.html" %}

{# קביעת ההקשר והלשונית הנבחרת #}
{% set current_tab = request.args.get('tab', 'AC1') %}
{% set tab_names = {
    'AC1': 'מיזוג 1/2',
    'AC2': 'מיזוג 2/2',
    'ROOMS': 'תאורת חדרים',
    'WC': 'תאורת שירותים',
    'HEATER': 'חימום מים'
} %}

{# מיפוי הקשרים עבור הבקר (PLC Context) #}
{% set context_map = {
    'AC1': 'BOYS_SH_AC1',
    'AC2': 'BOYS_SH_AC2',
    'ROOMS': 'BOYS_SH_ROOMS',
    'WC': 'BOYS_SH_WC',
    'HEATER': 'BOYS_SH_HEATER'
} %}
{% set active_ctx = context_map.get(current_tab, 'BOYS_SH_AC1') %}

{% block title %}שעוני שבת בנים - {{ tab_names[current_tab] }}{% endblock %}
{% block page_name %}שעוני שבת בנים - {{ tab_names[current_tab] }}{% endblock %}

{% block back_url %}/nav_control.html{% endblock %}
{# פעולת החזרה מעדכנת את הבקר שאנחנו יוצאים מתפריט השבת #}
{% block back_action %}BACK_{{ active_ctx }}{% endblock %}

{% block control_content %}
<div class="shabbat-wrapper">
    
    {# תפריט לשוניות עליון #}
    <div class="shabbat-tabs-nav">
        {% for tab_id, tab_label in tab_names.items() %}
            <a href="?tab={{ tab_id }}" class="shabbat-tab-link {{ 'active' if current_tab == tab_id }}">
                {{ tab_label }}
            </a>
        {% endfor %}
    </div>

    <div class="shabbat-status-header">
        <p>שליטה על זמני הפעלה מוגדרים (זמנים א-ד)</p>
    </div>

    {# גריד שעוני השבת #}
    <div class="shabbat-timers-grid">
        {% for i in range(1, 5) %}
        {% set timer_id = "TIMER_" ~ i %}
        {% set label = ['א', 'ב', 'ג', 'ד'][i-1] %}
        
        <div class="timer-card">
            <div class="timer-info">
                <span class="timer-label">זמן {{ label }}</span>
                <div class="status-indicator unknown" id="stat_{{ timer_id }}"></div>
            </div>
            
            <div class="timer-actions">
                <button type="button" 
                        class="shabbat-toggle-btn" 
                        onclick="handleControlAction('{{ timer_id }}_TOGGLE', '{{ active_ctx }}')">
                    שינוי מצב (ON/OFF)
                </button>
            </div>
            
            <div class="timer-note">הגדרת שעות בבקר בלבד</div>
        </div>
        {% endfor %}
    </div>
</div>

<style>
    .shabbat-wrapper { direction: rtl; padding: 10px; }

    /* עיצוב הטאבים */
    .shabbat-tabs-nav {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 25px;
        border-bottom: 2px solid #333;
        padding-bottom: 12px;
    }

    .shabbat-tab-link {
        text-decoration: none;
        background: #222;
        color: #aaa;
        padding: 10px 18px;
        border-radius: 6px;
        border: 1px solid #444;
        font-weight: bold;
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }

    .shabbat-tab-link.active {
        background: #ffcc00;
        color: #000;
        border-color: #ffcc00;
        box-shadow: 0 0 10px rgba(255, 204, 0, 0.3);
    }

    .shabbat-status-header {
        color: #888;
        margin-bottom: 20px;
        font-size: 0.9rem;
        text-align: right;
    }

    /* כרטיסי שעונים */
    .shabbat-timers-grid {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .timer-card {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 10px;
        padding: 15px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 15px;
    }

    .timer-info {
        display: flex;
        align-items: center;
        gap: 20px;
        min-width: 120px;
    }

    .timer-label {
        color: #ffcc00;
        font-size: 1.2rem;
        font-weight: bold;
    }

    /* נורית סטטוס לשעון */
    .status-indicator {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        background: #444;
    }
    .status-indicator.on { background: #00ff00; box-shadow: 0 0 10px #00ff00; }
    .status-indicator.off { background: #ff0000; box-shadow: 0 0 5px #700000; }

    .timer-actions { flex-grow: 1; text-align: left; }

    .shabbat-toggle-btn {
        background: #2a2a2a;
        color: #fff;
        border: 1px solid #555;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.2s;
        width: 100%;
        max-width: 200px;
    }

    .shabbat-toggle-btn:active {
        transform: scale(0.96);
        background: #333;
    }

    .timer-note {
        font-size: 0.75rem;
        color: #555;
        width: 100px;
        text-align: left;
    }

    /* התאמה למובייל */
    @media (max-width: 600px) {
        .timer-card {
            flex-direction: column;
            align-items: flex-start;
        }
        .timer-actions { width: 100%; text-align: center; }
        .shabbat-toggle-btn { max-width: 100%; }
        .timer-note { width: 100%; text-align: right; margin-top: 5px; }
    }
</style>

<script>
    /**
     * עדכון סטטוס השעונים מהבקר
     * הפונקציה נקראת אוטומטית ע"י control_base
     */
    function refreshControlStatus() {
        // אנחנו שולחים את ההקשר הנוכחי (למשל BOYS_SH_AC1) ל-API
        // כדי לקבל את המצב של 4 השעונים ששייכים ללשונית הזו
        updateControlIndicators('/api/status/shabbat?context={{ active_ctx }}');
    }
</script>
{% endblock %}
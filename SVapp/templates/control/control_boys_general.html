{% extends "control/control_base.html" %}

{% block page_name %}
    {{ page_title if page_title else "אזור בנים - הפעלה כללית" }}
{% endblock %}

{% block back_url %}/nav_control.html{% endblock %}
{% block back_action %}BOYS_GENERAL{% endblock %}

{# --- הגדרת המקרו לנורית אינדיקציה --- #}
{% macro gen_indicator(label, id) %}
<div class="indicator-cell">
    <div class="led-wrapper">
        <div class="status-indicator small unknown" id="stat_{{ id }}"></div>
    </div>
    <span class="indicator-label">{{ label }}</span>
</div>
{% endmacro %}

{% block control_content %}
<div class="boys-general-wrapper">
    <div class="top-row">
        <div class="gen-box">
            <h4 class="box-title">תאורת שירותים</h4>
            <div class="btns-row">
                <button type="button" class="btn-hmi btn-on" onclick="handleControlAction('BATHROOM_ON', 'BOYS_GENERAL')">ON</button>
                <button type="button" class="btn-hmi btn-off" onclick="handleControlAction('BATHROOM_OFF', 'BOYS_GENERAL')">OFF</button>
            </div>
            <div class="indicators-grid">
                {# שורה 1: Y=310 - בתים 1-4 #}
                <div class="y-row" data-y="310">
                    {{ gen_indicator("בית 4", "T_B4") }}
                    {{ gen_indicator("בית 3", "T_B3") }}
                    {{ gen_indicator("בית 2", "T_B2") }}
                    {{ gen_indicator("בית 1", "T_B1") }}
                </div>
                {# שורה 2: Y=390 - בתים 5, 9 #}
                <div class="y-row" data-y="390">
                    {{ gen_indicator("בית 5", "T_B5") }}
                    {{ gen_indicator("בית 9", "T_B9") }}
                </div>
                {# שורה 3: Y=470 - בית 11א #}
                <div class="y-row" data-y="470">
                    {{ gen_indicator("בית 11 - א", "T_B11A") }}
                </div>
                {# שורה 4: Y=550 - בית 11ב #}
                <div class="y-row" data-y="550">
                    {{ gen_indicator("בית 11 - ב", "T_B11B") }}
                </div>
            </div>
        </div>

        <div class="gen-box">
            <h4 class="box-title">תאורת חדרים</h4>
            <div class="btns-row">
                <button type="button" class="btn-hmi btn-on" onclick="handleControlAction('ROOMS_ON', 'BOYS_GENERAL')">ON</button>
                <button type="button" class="btn-hmi btn-off" onclick="handleControlAction('ROOMS_OFF', 'BOYS_GENERAL')">OFF</button>
            </div>
            <div class="indicators-grid">
                {# שורה 1: Y=314 - בתים 1-4 #}
                <div class="y-row" data-y="314">
                    {{ gen_indicator("בית 4", "R_B4") }}
                    {{ gen_indicator("בית 3", "R_B3") }}
                    {{ gen_indicator("בית 2", "R_B2") }}
                    {{ gen_indicator("בית 1", "R_B1") }}
                </div>
                {# שורה 2: Y=394 - בתים 5, 9 #}
                <div class="y-row" data-y="394">
                    {{ gen_indicator("בית 5", "R_B5") }}
                    {{ gen_indicator("בית 9", "R_B9") }}
                </div>
                {# שורה 3: Y=474 - בית 11א #}
                <div class="y-row" data-y="474">
                    {{ gen_indicator("בית 11 - א", "R_B11A") }}
                </div>
                {# שורה 4: Y=554 - בית 11ב #}
                <div class="y-row" data-y="554">
                    {{ gen_indicator("בית 11 - ב", "R_B11B") }}
                </div>
            </div>
        </div>

        <div class="gen-box">
            <h4 class="box-title">מיזוג אוויר</h4>
            <div class="btns-row">
                <button type="button" class="btn-hmi btn-on" onclick="handleControlAction('AC_ON', 'BOYS_GENERAL')">ON</button>
                <button type="button" class="btn-hmi btn-off" onclick="handleControlAction('AC_OFF', 'BOYS_GENERAL')">OFF</button>
            </div>
            <div class="indicators-grid">
                {# שורה 1: Y=314 - בתים 1-4 #}
                <div class="y-row" data-y="314">
                    {{ gen_indicator("בית 4", "AC_B4") }}
                    {{ gen_indicator("בית 3", "AC_B3") }}
                    {{ gen_indicator("בית 2", "AC_B2") }}
                    {{ gen_indicator("בית 1", "AC_B1") }}
                </div>
                {# שורה 2: Y=394 - בתים 5, 9 #}
                <div class="y-row" data-y="394">
                    {{ gen_indicator("בית 5", "AC_B5") }}
                    {{ gen_indicator("9-א", "AC_B9A") }}
                    {{ gen_indicator("9-ב", "AC_B9B") }}
                </div>
                {# שורה 3: Y=474 - בית 11א #}
                <div class="y-row" data-y="474">
                    <div class="row-label-cell">בית 11 קומה א'</div>
                    {{ gen_indicator("א", "AC_B11AA") }}
                    {{ gen_indicator("ב", "AC_B11AB") }}
                </div>
                {# שורה 4: Y=554 - בית 11ב #}
                <div class="y-row" data-y="554">
                    <div class="row-label-cell">בית 11 קומה ב'</div>
                    {{ gen_indicator("א", "AC_B11BA") }}
                    {{ gen_indicator("ב", "AC_B11BB") }}
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-row">
        <div class="gen-box empty-box">
            <div class="proverb">"סוף מעשה במחשבה תחילה"</div>
        </div>

        <div class="gen-box heater-box-centered">
            <h4 class="box-title">חימום מים בית 11</h4>
            <div class="btns-row centered">
                <button type="button" class="btn-hmi btn-on" onclick="handleControlAction('HEATER_ON', 'BOYS_GENERAL')">ON</button>
                <button type="button" class="btn-hmi btn-off" onclick="handleControlAction('HEATER_OFF', 'BOYS_GENERAL')">OFF</button>
            </div>
            <div class="heater-indicators">
                {{ gen_indicator("קומה ב", "W_B11B") }}
                {{ gen_indicator("קומה א", "W_B11A") }}
            </div>
        </div>

        <div class="gen-box legend-box">
            <p class="legend-header">מקרא</p>
            <div class="legend-content">
                <p>בית 9 מיזוג א': חדרים 900-902</p>
                <p>בית 9 מיזוג ב': חדרים 903-905</p>
                <hr class="legend-sep">
                <p>בית 11 קומה א' מיזוג א'/ב': חדרים 1-6</p>
                <p>בית 11 קומה ב' מיזוג א'/ב': חדרים 7-13</p>
            </div>
        </div>
    </div>
</div>

<style>
    .boys-general-wrapper { 
        direction: rtl; 
        padding: 15px; 
        display: flex; 
        flex-direction: column; 
        gap: 25px; 
        background: #1a1a1a;
        min-height: 100vh;
    }
    
    .top-row, .bottom-row { 
        display: grid; 
        grid-template-columns: repeat(3, 1fr); 
        gap: 20px; 
        justify-items: center; 
        align-items: start; 
    }
    
    /* תצוגת מסך צר - מקסימום 2 קוביות בשורה */
    @media (max-width: 1000px) {
        .top-row, .bottom-row { 
            grid-template-columns: repeat(2, 1fr); 
        }
    }
    
    @media (max-width: 750px) {
        .top-row, .bottom-row { 
            grid-template-columns: 1fr; 
        }
    }
    
    .gen-box { 
        background: #2d2d2d; 
        border: 2px solid #444; 
        border-radius: 8px; 
        padding: 20px 15px 15px; 
        width: 100%; 
        box-sizing: border-box; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.8);
        position: relative;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .gen-box:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.9);
    }
    
    .box-title { 
        color: #3d5a80; 
        text-align: center; 
        border-bottom: 2px solid #444; 
        padding-bottom: 10px; 
        margin-bottom: 20px; 
        font-size: 1.1rem; 
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .btns-row { 
        display: flex; 
        justify-content: center; 
        gap: 15px; 
        margin-bottom: 25px; 
    }
    
    .btn-hmi { 
        padding: 10px 20px; 
        border-radius: 4px; 
        cursor: pointer; 
        font-weight: bold; 
        border: 1px solid #555;
        min-width: 70px;
        text-transform: uppercase;
        transition: all 0.2s;
    }
    
    .btn-hmi:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    }
    
    .btn-on { 
        background: #004d00; 
        color: #90ee90;
        border-color: #006600;
    }
    
    .btn-on:hover {
        background: #006600;
        box-shadow: 0 0 12px rgba(0, 200, 0, 0.4);
    }
    
    .btn-off { 
        background: #4d0000; 
        color: #ff6b6b;
        border-color: #660000;
    }
    
    .btn-off:hover {
        background: #660000;
        box-shadow: 0 0 12px rgba(200, 0, 0, 0.4);
    }

    .indicators-grid { 
        display: flex; 
        flex-direction: column; 
        gap: 15px; 
    }
    
    /* שורות עם אותו Y - מופרדות בבירור */
    .y-row {
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .y-row:last-child {
        border-bottom: none;
    }
    
    .indicator-cell { 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        width: 100%; 
    }
    
    .indicator-label { 
        font-size: 0.75rem; 
        color: #bbb; 
        text-align: center; 
        margin-top: 6px; 
        white-space: nowrap; 
    }
    
    /* .status-indicator styles are now in style.css - unified LED system */

    .full-width-label { 
        grid-column: span 4; 
        justify-self: start; 
        padding-right: 15px; 
    }
    
    .row-label-cell { 
        grid-column: 4; 
        justify-self: end; 
        color: #888; 
        font-size: 0.75rem; 
        align-self: center; 
    }
    
    .heater-indicators { 
        display: flex; 
        justify-content: center; 
        gap: 40px; 
        margin-top: 10px; 
    }

    .legend-box { 
        text-align: right; 
        color: #ccc; 
        font-size: 0.85em;
        background: #252525;
        border: 1px solid #333;
    }
    
    .legend-header { 
        text-align: center; 
        font-weight: bold; 
        margin-bottom: 10px; 
        color: #fff; 
        text-decoration: underline; 
    }
    
    .legend-sep { 
        border: 0; 
        border-top: 1px solid #333; 
        margin: 10px 0; 
    }
    
    .empty-box { 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        border: 1px dashed #444; 
        min-height: 100px; 
        background: #1e1e1e;
    }
    
    .proverb { 
        color: #666; 
        font-style: italic; 
        text-align: center; 
    }

</style>

<script>
    /**
     * פונקציה לעדכון מצב הנורות - נקראת אוטומטית מ-control_base
     */
    function refreshControlStatus() {
        // שימוש ב-MONITOR_POINTS_CONTROL_GEN עם המפתח "boys"
        fetch('/api/status/boys/general')
            .then(res => {
                if (!res.ok) {
                    console.error(`API Error: ${res.status}`);
                    return null;
                }
                return res.json();
            })
            .then(data => {
                if (!data || data.error) {
                    if (data && data.error) console.error("API Error:", data.error);
                    return;
                }
                
                for (const [key, val] of Object.entries(data)) {
                    const el = document.getElementById('stat_' + key);
                    if (el) {
                        el.classList.remove('on', 'off', 'unknown');
                        el.classList.add(String(val).toLowerCase());
                    }
                }
            })
            .catch(err => {
                console.error("Status Update Failed:", err);
                document.querySelectorAll('.status-indicator').forEach(el => {
                    el.classList.remove('on', 'off');
                    el.classList.add('unknown');
                });
            });
    }
</script>
{% endblock %}
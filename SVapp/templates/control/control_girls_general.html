{% extends "control/control_base.html" %}
{% block active_ctx %}{{ active_ctx }}{% endblock %}

{% block title %}אזור בנות - הפעלה כללית{% endblock %}
{% block page_name %}אזור בנות - הפעלה כללית של מערכות{% endblock %}

{# חזרה לתפריט הניווט הראשי #}
{% block back_url %}/nav_control.html{% endblock %}
{% block back_action %}GIRLS_GENERAL{% endblock %}

{# --- הגדרת המקרו לנורית אינדיקציה --- #}
{% macro gen_indicator(label, id) %}
<div class="indicator-cell">
    <div class="led-wrapper">
        <div class="status-indicator small unknown" id="stat_{{ id }}"></div>
    </div>
    <span class="indicator-label">{{ label }}</span>
</div>
{% endmacro %}

{% block control_content %}
<div class="girls-general-wrapper">
    <div class="main-grid">
        
        {# --- עמודה 1: מיזוג אוויר --- #}
        <div class="gen-box">
            <h4 class="box-title">
                <i class="fas fa-snowflake"></i> מיזוג אוויר
            </h4>
            <div class="btns-row">
                <button type="button" class="btn-hmi btn-on" onclick="handleControlAction('AC_ON', 'GIRLS_GENERAL')">הכל ON</button>
                <button type="button" class="btn-hmi btn-off" onclick="handleControlAction('AC_OFF', 'GIRLS_GENERAL')">הכל OFF</button>
            </div>
            
            <div class="indicators-container">
                {# שורה 1: Y=303 - בתים 7, 8, 10 #}
                <div class="indicator-row y-row" data-y="303">
                    {{ gen_indicator("7-א", "G7A_AC") }} 
                    {{ gen_indicator("7-ב", "G7B_AC") }} 
                    {{ gen_indicator("8", "G8_AC") }} 
                    {{ gen_indicator("10-א", "G10A_AC") }}
                </div>
                
                {# שורה 2: Y=372 - בית 12 #}
                <div class="indicator-row y-row" data-y="372">
                    {{ gen_indicator("12א", "G12A_AC") }} 
                    {{ gen_indicator("12ב", "G12B_AC") }} 
                    {{ gen_indicator("10ב", "G10B_AC") }}
                </div>
                
                {# שורה 3: Y=439 - בית 13 #}
                <div class="indicator-row y-row" data-y="439">
                    {{ gen_indicator("13א", "G13A_AC") }} 
                    {{ gen_indicator("13ב", "G13B_AC") }} 
                    {{ gen_indicator("12ג", "G12C_AC") }}
                </div>
                
                {# שורה 4: Y=548 - קרוואנים + 13ג #}
                <div class="indicator-row y-row caravan-row" data-y="548">
                    {{ gen_indicator("13ג", "G13C_AC") }}
                    {% for i in range(20, 27) %}
                        {{ gen_indicator(i, "GC" ~ i ~ "_AC") }}
                    {% endfor %}
                </div>
            </div>
        </div>

        {# --- עמודה 2: תאורת חדרים --- #}
        <div class="gen-box">
            <h4 class="box-title">
                <i class="fas fa-lightbulb"></i> תאורת חדרים
            </h4>
            <div class="btns-row">
                <button type="button" class="btn-hmi btn-on" onclick="handleControlAction('ROOMS_ON', 'GIRLS_GENERAL')">הכל ON</button>
                <button type="button" class="btn-hmi btn-off" onclick="handleControlAction('ROOMS_OFF', 'GIRLS_GENERAL')">הכל OFF</button>
            </div>
            <div class="indicators-container">
                {# שורה 1: Y=303 - בתים 7, 8, 10 #}
                <div class="indicator-row y-row" data-y="303">
                    {{ gen_indicator("בית 7", "G7_R") }} 
                    {{ gen_indicator("בית 8", "G8_R") }} 
                    {{ gen_indicator("בית 10", "G10_R") }}
                </div>
                
                {# שורה 2: Y=372 - בית 12 #}
                <div class="indicator-row y-row" data-y="372">
                    {{ gen_indicator("12א", "G12A_R") }} 
                    {{ gen_indicator("12ב", "G12B_R") }} 
                    {{ gen_indicator("12ג", "G12C_R") }}
                </div>
                
                {# שורה 3: Y=439 - בית 13 #}
                <div class="indicator-row y-row" data-y="439">
                    {{ gen_indicator("13א", "G13A_R") }} 
                    {{ gen_indicator("13ב", "G13B_R") }} 
                    {{ gen_indicator("13ג", "G13C_R") }}
                </div>
                
                {# שורה 4: Y=548 - קרוואנים #}
                <div class="indicator-row y-row caravan-row" data-y="548">
                    {% for i in range(20, 27) %}
                        {{ gen_indicator(i, "GC" ~ i ~ "_R") }}
                    {% endfor %}
                </div>
            </div>
        </div>

        {# --- עמודה 3: תאורת שירותים + חימום מים --- #}
        <div class="column-stack">
            {# תאורת שירותים #}
            <div class="gen-box">
                <h4 class="box-title">תאורת שירותים</h4>
                <div class="btns-row">
                    <button type="button" class="btn-hmi btn-on" onclick="handleControlAction('BATHROOM_ON', 'GIRLS_GENERAL')">ON</button>
                    <button type="button" class="btn-hmi btn-off" onclick="handleControlAction('BATHROOM_OFF', 'GIRLS_GENERAL')">OFF</button>
                </div>
                <div class="indicators-container">
                    {# שורה 1: Y=303 - בתים 7, 8, 10 #}
                    <div class="indicator-row y-row" data-y="303">
                        {{ gen_indicator("בית 7", "G7_T") }} 
                        {{ gen_indicator("בית 8", "G8_T") }} 
                        {{ gen_indicator("בית 10", "G10_T") }}
                    </div>
                    {# שורה 2: Y=372 - בית 12 #}
                    <div class="indicator-row y-row" data-y="372">
                        {{ gen_indicator("12א", "G12A_T") }} 
                        {{ gen_indicator("12ב", "G12B_T") }} 
                        {{ gen_indicator("12ג", "G12C_T") }}
                    </div>
                    {# שורה 3: Y=439 - בית 13 #}
                    <div class="indicator-row y-row" data-y="439">
                        {{ gen_indicator("13א", "G13A_T") }} 
                        {{ gen_indicator("13ב", "G13B_T") }} 
                        {{ gen_indicator("13ג", "G13C_T") }}
                    </div>
                </div>
            </div>

            {# חימום מים #}
            <div class="gen-box heater-box">
                <h4 class="box-title" style="color: #e67e22;">חימום מים (דודים)</h4>
                <div class="btns-row">
                    <button type="button" class="btn-hmi btn-on" style="background: #e67e22;" onclick="handleControlAction('HEATER_ON', 'GIRLS_GENERAL')">ON</button>
                    <button type="button" class="btn-hmi btn-off" onclick="handleControlAction('HEATER_OFF', 'GIRLS_GENERAL')">OFF</button>
                </div>
                <div class="indicator-row">
                    {{ gen_indicator("בית 8", "G8_W") }}
                    {{ gen_indicator("בית 10", "G10_W") }}
                    {{ gen_indicator("בית 12", "G12_W") }}
                    {{ gen_indicator("בית 13", "G13_W") }}
                </div>
            </div>
        </div>
        
    </div>
</div>

<style>
    .girls-general-wrapper { direction: rtl; padding: 10px; }
    
    .main-grid { 
        display: grid; 
        grid-template-columns: repeat(3, 1fr); 
        gap: 20px; 
        align-items: start;
    }
    
    /* תצוגת מסך צר - מקסימום 2 קוביות בשורה */
    @media (max-width: 1100px) {
        .main-grid { 
            grid-template-columns: repeat(2, 1fr); 
        }
    }
    
    @media (max-width: 750px) {
        .main-grid { 
            grid-template-columns: 1fr; 
        }
    }

    .column-stack { display: flex; flex-direction: column; gap: 20px; }

    .gen-box { 
        background: var(--dark-box-bg-alt, #161616); 
        border: 1px solid #333; 
        border-radius: 12px; 
        padding: 18px; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    }

    .box-title { 
        color: #ffcc00; 
        text-align: center; 
        border-bottom: 1px solid #333; 
        padding-bottom: 10px; 
        margin-bottom: 15px; 
        font-size: 1.1rem; 
        font-weight: bold;
    }

    .btns-row { display: flex; justify-content: center; gap: 12px; margin-bottom: 20px; }
    
    .btn-hmi { 
        padding: 10px 18px; 
        border-radius: 8px; 
        cursor: pointer; 
        font-weight: bold; 
        border: none; 
        min-width: 80px;
        transition: transform 0.1s;
    }
    .btn-hmi:active { transform: scale(0.95); }
    .btn-on { background: #2ecc71; color: white; }
    .btn-off { background: #e74c3c; color: white; }

    .indicators-container { display: flex; flex-direction: column; gap: 15px; }
    .indicator-row { 
        display: flex; 
        justify-content: center; 
        gap: 12px; 
        flex-wrap: wrap; 
        align-items: center;
    }
    
    /* שורות עם אותו Y - מופרדות בבירור */
    .y-row {
        padding: 8px 0;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .y-row:last-child {
        border-bottom: none;
    }
    
    /* סידור גריד לקרוואנים */
    .caravan-row { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(50px, 1fr)); 
        gap: 10px; 
        justify-items: center; 
    }

    .indicator-cell { display: flex; flex-direction: column; align-items: center; width: 45px; }
    .indicator-label { font-size: 0.75rem; color: #999; margin-top: 5px; }

    /* .status-indicator styles are now in style.css - unified LED system */

</style>

<script>
    /**
     * פונקציה לעדכון מצב הנורות - נקראת אוטומטית מ-control_base
     */
    function refreshControlStatus() {
        // שימוש ב-MONITOR_POINTS_CONTROL_GEN עם המפתח "girls"
        fetch('/api/status/girls/general')
            .then(res => {
                if (!res.ok) {
                    console.error(`API Error: ${res.status}`);
                    return null;
                }
                return res.json();
            })
            .then(data => {
                if (!data || data.error) {
                    if (data && data.error) console.error("API Error:", data.error);
                    return;
                }
                
                for (const [key, val] of Object.entries(data)) {
                    const el = document.getElementById('stat_' + key);
                    if (el) {
                        el.classList.remove('on', 'off', 'unknown');
                        el.classList.add(String(val).toLowerCase());
                    }
                }
            })
            .catch(err => {
                console.error("Status Update Failed:", err);
                document.querySelectorAll('.status-indicator').forEach(el => {
                    el.classList.remove('on', 'off');
                    el.classList.add('unknown');
                });
            });
    }
</script>
{% endblock %}
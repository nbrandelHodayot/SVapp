{% extends "base_layout.html" %}

{% block page_name %}
    {{ page_title if page_title else "שעוני שבת" }}
{% endblock %}

{% block back_url %}/control.html{% endblock %}
{# שימוש ב-BACK_CONFIG שהגדרנו ב-config.py #}
{% block back_action %}BACK_{{ back_ctx if back_ctx else active_ctx }}{% endblock %}

{% block content %}
<div class="shabbat-container {{ 'public-club-layout' if is_public_club }}">
    
    {# תפריט צד אנכי - מופיע רק באזורים ציבוריים/מועדונים #}
    {% if is_public_club %}
    <aside class="vertical-sidebar">
        {% for key, label in vertical_tabs %}
        <button class="v-tab-button {{ 'active' if current_v_tab == key }}"
                onclick="changeVerticalTab('{{ key }}')">
            {{ label }}
        </button>
        {% endfor %}
    </aside>
    {% endif %}

    <div class="main-shabbat-ui">
        {# טאבים אופקיים עליונים - החלפה בין תאורה, מיזוג, חימום וכו' #}
        <nav class="horizontal-tabs">
            {% for key, label in tabs_config %}
            <button class="h-tab-button {{ 'active' if current_tab == key }}" 
                    onclick="changeHorizontalTab('{{ key }}')">
                {{ label }}
            </button>
            {% endfor %}
        </nav>

        {# תצוגת שעוני השבת - לכל מסך בבקר יש 4 זמנים #}
        <div class="clocks-grid">
            {% for i in range(1, 5) %}
            <div class="clock-row">
                <span class="clock-label">זמן {{ ['א','ב','ג','ד'][i-1] }}</span>
                <div class="clock-actions">
                    {# הפורמט: CONTEXT/ACTION. ה-active_ctx מוודא שהבקר במסך הנכון לפני הלחיצה #}
                    <button class="btn-toggle" onclick="handleButtonClick('{{ active_ctx }}/TIMER_{{ i }}_TOGGLE')">החלף מצב (ON/OFF)</button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
/**
 * שינוי טאב אופקי (למשל ממיזוג לתאורה)
 * @param tabKey - המפתח כפי שמופיע ב-COMMON_COORDS (למשל HEATER, AC)
 */
function changeHorizontalTab(tabKey) {
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('tab', tabKey);
    
    // שליחת פקודה בפורמט CONTEXT/ACTION
    // הפקודה בבקר תהיה TAB_HEATER, TAB_AC וכו'
    handleButtonClick('{{ active_ctx }}/TAB_' + tabKey);
    
    // השהייה קלה לעדכון הבקר לפני רענון הדף
    setTimeout(() => {
        window.location.search = urlParams.toString();
    }, 300);
}

/**
 * שינוי אזור (מעבר בין מבנים במועדון הציבורי)
 * @param vTabKey - מפתח ה-Context החדש (למשל CLUBS_PUBLIC_HOLLAND)
 */
function changeVerticalTab(vTabKey) {
    // כאן אנחנו עוברים להקשר (Context) חדש לגמרי
    handleButtonClick(vTabKey);
    
    setTimeout(() => {
        const url = new URL(window.location.href);
        url.pathname = '/clubs_public.html';
        url.searchParams.set('area', vTabKey);
        window.location.href = url.toString();
    }, 300);
}
</script>

<style>
    .shabbat-container { display: flex; flex-direction: column; gap: 20px; direction: rtl; }
    .public-club-layout { flex-direction: row; }

    /* תפריט צד - אנכי */
    .vertical-sidebar { width: 200px; display: flex; flex-direction: column; gap: 8px; border-left: 1px solid #444; padding-left: 15px; }
    .v-tab-button { padding: 15px; background: #2a2a2a; color: #fff; border: 1px solid #333; cursor: pointer; border-radius: 4px; text-align: right; font-size: 14px; transition: 0.2s; }
    .v-tab-button.active { background: #007bff; border-color: #0056b3; font-weight: bold; }
    .v-tab-button:hover { background: #3a3a3a; }

    /* טאבים אופקיים */
    .main-shabbat-ui { flex-grow: 1; display: flex; flex-direction: column; gap: 20px; }
    .horizontal-tabs { display: flex; gap: 8px; border-bottom: 2px solid #333; padding-bottom: 10px; }
    .h-tab-button { padding: 12px 20px; background: #222; color: #aaa; border: 1px solid #333; cursor: pointer; border-radius: 5px 5px 0 0; transition: 0.2s; }
    .h-tab-button.active { background: #333; color: #fff; border-bottom: 4px solid #007bff; font-weight: bold; }
    .h-tab-button:hover { color: #fff; background: #2a2a2a; }

    /* רשת השעונים */
    .clocks-grid { background: #000; padding: 25px; border-radius: 10px; border: 1px solid #222; }
    .clock-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #222; }
    .clock-row:last-child { border-bottom: none; }
    .clock-label { font-size: 1.2em; color: #eee; }
    .btn-toggle { padding: 10px 20px; background: #444; color: #fff; border: 1px solid #555; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
    .btn-toggle:hover { background: #007bff; border-color: #0056b3; }
</style>
{% endblock %}
{% extends "base_layout.html" %}
{% block active_ctx %}{{ active_ctx }}{% endblock %}

{% block page_name %}
    {{ page_title if page_title else "שעוני שבת" }}
{% endblock %}

{% block back_url %}/nav_control.html{% endblock %}
{% block back_action %}BACK_{{ back_ctx if back_ctx else active_ctx }}{% endblock %}

{% block content %}
<div class="shabbat-container {{ 'public-club-layout' if is_public_club }}">
    
    {% if is_public_club %}
    <aside class="vertical-sidebar">
        {% for key, label in vertical_tabs %}
        <button class="v-tab-button {{ 'active' if current_v_tab == key }}"
                onclick="changeVerticalTab('{{ key }}')">
            {{ label }}
        </button>
        {% endfor %}
    </aside>
    {% endif %}

    <div class="main-shabbat-ui">
        <nav class="horizontal-tabs">
            {% for key, label in tabs_config %}
            <button class="h-tab-button {{ 'active' if current_tab == key }}" 
                    onclick="switchShabbatTab('TAB_{{ key }}', '/control_{{ area_name }}_shabbat.html?tab={{ key }}')">
                {{ label }}
            </button>
            {% endfor %}
        </nav>

        <div class="clocks-grid">
            {% for i in range(1, 5) %}
            <div class="clock-row">
                <div class="clock-info">
                    <span class="clock-label">שעון {{ ['א','ב','ג','ד'][loop.index0] }}</span>
                    <div class="clock-times">
                        <span id="time_on_{{ loop.index0 }}">--:--</span> | <span id="time_off_{{ loop.index0 }}">--:--</span>
                    </div>
                </div>
                <div class="clock-actions">
                    <button id="toggle_TIMER_{{ i }}" 
                            class="btn-toggle-shabbat unknown" 
                            onclick="handleShabbatToggle('{{ active_ctx }}', {{ i }})">
                        טוען...
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
/**
 * עדכון ויזואלי של הכפתורים והשעות
 */
function updateClockVisuals(data) {
    if (!data) return;

    // 1. עדכון כפתורי ה-Toggle
    const statuses = data.clocks_status || {};
    for (let i = 1; i <= 4; i++) {
        const btn = document.getElementById(`toggle_TIMER_${i}`);
        if (!btn) continue;

        const status = statuses[`TIMER_${i}`] || 'OFF';
        btn.innerText = status;
        btn.className = 'btn-toggle-shabbat ' + status.toLowerCase();
    }

    // 2. עדכון שעות ה-OCR
    if (data.clocks && Array.isArray(data.clocks)) {
        data.clocks.forEach((clock, index) => {
            const onElem = document.getElementById(`time_on_${index}`);
            const offElem = document.getElementById(`time_off_${index}`);
            if (onElem) onElem.innerText = clock.on_time || "--:--";
            if (offElem) offElem.innerText = clock.off_time || "--:--";
        });
    }
}

/**
 * רענון נתונים מהשרת
 */
function refreshShabbatStatus() {
    fetch(`/api/status/shabbat?context={{ active_ctx }}`)
        .then(res => res.json())
        .then(data => updateClockVisuals(data))
        .catch(err => console.error("Refresh error:", err));
}

/**
 * הפעלה/כיבוי שעון
 */
async function handleShabbatToggle(context, index) {
    const btn = document.getElementById(`toggle_TIMER_${index}`);
    const action = btn.classList.contains('on') ? 'OFF' : 'ON';
    const fullAction = `${context}/TIMER_${index}_${action}`;
    
    try {
        btn.innerText = '...';
        const response = await fetch('/control?action=' + encodeURIComponent(fullAction));
        if (response.ok) {
            setTimeout(refreshShabbatStatus, 1000);
        }
    } catch (e) { console.error("Toggle failed", e); }
}

/**
 * מעבר טאבים (כמו בדפי הסטטוס)
 */
async function switchShabbatTab(tabAction, targetUrl) {
    const footer = document.getElementById('status-message');
    const fullAction = "{{ active_ctx }}/" + tabAction;
    
    if (footer) footer.innerText = "מעביר דף בבקר...";

    try {
        await fetch('/control?action=' + encodeURIComponent(fullAction));
        setTimeout(() => { window.location.href = targetUrl; }, 400); 
    } catch (e) { window.location.href = targetUrl; }
}

document.addEventListener('DOMContentLoaded', () => {
    refreshShabbatStatus();
    setInterval(refreshShabbatStatus, 5000); 
});
</script>

<style>
    .shabbat-container { display: flex; flex-direction: column; gap: 20px; direction: rtl; font-family: sans-serif; }
    .horizontal-tabs { display: flex; gap: 5px; border-bottom: 2px solid #444; padding-bottom: 0; }
    .h-tab-button { padding: 12px 25px; background: #1a1a1a; color: #888; border: 1px solid #333; border-bottom: none; cursor: pointer; border-radius: 8px 8px 0 0; }
    .h-tab-button.active { background: #333; color: #fff; border-top: 3px solid #007bff; font-weight: bold; }
    .clocks-grid { background: #111; padding: 20px; border-radius: 12px; border: 1px solid #222; }
    .clock-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #222; }
    .clock-info { display: flex; flex-direction: column; gap: 5px; }
    .clock-label { font-size: 1.1rem; color: #ddd; font-weight: 500; }
    .clock-times { font-size: 0.9rem; color: #888; font-family: monospace; }
    .btn-toggle-shabbat { width: 100px; padding: 12px; border-radius: 8px; border: 2px solid #444; font-weight: bold; cursor: pointer; transition: all 0.3s ease; text-align: center; }
    .btn-toggle-shabbat.on { background-color: #28a745; color: white; border-color: #1e7e34; box-shadow: 0 0 10px rgba(40, 167, 69, 0.3); }
    .btn-toggle-shabbat.off { background-color: #dc3545; color: white; border-color: #a71d2a; }
    .btn-toggle-shabbat.unknown { background-color: #444; color: #888; }
</style>
{% endblock %}
{% extends "status/status_base.html" %}
{% set active_tab = 'boys' %}
{% set current_context = 'STATUS_BOYS' %}
{% block context_name %}STATUS_BOYS{% endblock %}

{# --- הגדרת המקרואים --- #}
{% macro led(id) %}
    <div id="stat_{{ id }}" class="led-indicator unknown"></div>
{% endmacro %}

{% macro house_box(title, prefix, extra_ac=false, water_heat=false) %}
<div class="hmi-box">
    <div class="box-header">{{ title }}</div>
    
    {% if not extra_ac %}
        <div class="box-line"><span>מיזוג אוויר</span> {{ led("SB_" ~ prefix ~ "_AC") }}</div>
    {% else %}
        <div class="box-line"><span class="small-text">{{ extra_ac[0] }}</span> {{ led("SB_" ~ prefix ~ "_AC1") }}</div>
        <div class="box-line"><span class="small-text">{{ extra_ac[1] }}</span> {{ led("SB_" ~ prefix ~ "_AC2") }}</div>
    {% endif %}

    <div class="box-line"><span>תאורת חדרים</span> {{ led("SB_" ~ prefix ~ "_R") }}</div>
    <div class="box-line"><span>תאורת שירותים</span> {{ led("SB_" ~ prefix ~ "_T") }}</div>

    {% if water_heat %}
        <div class="box-line"><span>חימום מים</span> {{ led("SB_" ~ prefix ~ "_WH") }}</div>
    {% endif %}
</div>
{% endmacro %}

{% macro club_row(num) %}
<div class="club-row">
    <div class="club-cell name">מועדון בית {{ num }}</div>
    <div class="club-cell sensor">
        <span>מצב חיישן:</span>
        <span id="stat_SB_C{{num}}_S" class="sensor-val">טוען...</span>
    </div>
    <div class="club-cell inline-led">
        <span>תאורה</span>
        {{ led("SB_C" ~ num ~ "_L") }}
    </div>
    <div class="club-cell inline-led">
        <span>מיזוג אוויר</span>
        {{ led("SB_C" ~ num ~ "_AC") }}
    </div>
</div>
{% endmacro %}

{# --- תוכן הדף --- #}

{% block page_name %}סטטוס מערכות - בנים{% endblock %}
{% block back_action %}STATUS_BOYS{% endblock %}

{% block status_content %}
<div class="hmi-dashboard" dir="rtl">
    
    {# גריד הבתים - הוגדר ל-3 עמודות ב-CSS למטה #}
    <div class="houses-grid">
        {# שורה 1 #}
        {{ house_box("בית 1", "B1") }}
        {{ house_box("בית 2", "B2") }}
        {{ house_box("בית 3", "B3") }}

        {# שורה 2 #}
        {{ house_box("בית 4", "B4") }}
        {{ house_box("בית 5", "B5") }}
        {{ house_box("בית 9", "B9", extra_ac=["מיזוג 900-902", "מיזוג 903-905"]) }}

        {# שורה 3 - בתים 11 תופסים את המקומות הנותרים #}
        {{ house_box("בית 11 קומה א'", "B11A", extra_ac=["מיזוג 1-3", "מיזוג 4-6"], water_heat=true) }}
        {{ house_box("בית 11 קומה ב'", "B11B", extra_ac=["מיזוג 7-9", "מיזוג 10-13"], water_heat=true) }}
    </div>

    <div class="section-divider"></div>
    <div class="clubs-header">סטטוס מועדונים</div>

    {# אזור מועדונים #}
    <div class="clubs-container">
        <div class="clubs-list">
            {% for i in [1, 2, 3, 4, 9, 11] %}
                {{ club_row(i) }}
            {% endfor %}
        </div>
    </div>
</div>

<style>
    .hmi-dashboard { background: #000; padding: 15px; color: white; border-radius: 10px; }
    
    /* הגדרת הגריד ל-3 עמודות שוות */
    .houses-grid { 
        display: grid; 
        grid-template-columns: repeat(3, 1fr); 
        gap: 12px; 
        margin-bottom: 20px; 
    }
    
    .hmi-box { 
        background: #1a1a1a; 
        border: 1px solid #444; 
        border-radius: 8px; 
        padding: 10px; 
        min-height: 150px; 
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    
    .box-header { text-align: center; border-bottom: 1px solid #333; margin-bottom: 10px; font-weight: bold; color: #00d2ff; padding-bottom: 5px; }
    .box-line { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-size: 0.85rem; }
    .small-text { font-size: 0.7rem; color: #aaa; line-height: 1; }

    .section-divider { height: 2px; background: #333; margin: 30px 0 10px 0; }
    .clubs-header { text-align: center; color: #ffcc00; font-weight: bold; margin-bottom: 15px; font-size: 1.2rem; }

    .club-row { 
        display: grid; grid-template-columns: 1.5fr 1fr 1fr 1fr; 
        width: 100%; padding: 12px 5px; border-bottom: 1px solid #222; align-items: center;
    }
    .club-cell { font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
    .club-cell.name { font-weight: bold; color: #00d2ff; }
    .sensor-val { color: #0f0; font-weight: bold; font-size: 0.8rem; }
    .inline-led { display: flex; align-items: center; gap: 8px; }

    .led-indicator { flex-shrink: 0; }
    /* Size, colors, and other styles from unified CSS (style.css) */

    /* התאמה למובייל - אם המסך צר מאוד, יעבור ל-2 עמודות */
    @media (max-width: 480px) {
        .houses-grid { grid-template-columns: repeat(2, 1fr); }
        .club-row { grid-template-columns: 1fr 1fr; gap: 10px; }
    }
</style>
<script>
function refreshPageData() {
    fetch('/api/status/boys') // שים לב לנתיב המדויק ב-server_app.py
        .then(res => res.json())
        .then(data => {
            for (const [key, val] of Object.entries(data)) {
                const el = document.getElementById('stat_' + key);
                if (el) {
                    // עדכון קלאסים לפי ה-CSS שלך (on/off/unknown)
                    el.className = 'led-indicator ' + val.toLowerCase();
                    
                    // אם זה טקסט (חיישן)
                    if (el.classList.contains('sensor-val')) {
                        el.innerText = (val === 'ON') ? 'פעיל' : 'מנוטרל';
                    }
                }
            }
        });
}

document.addEventListener('DOMContentLoaded', () => {
    refreshPageData();
    setInterval(refreshPageData, 5000); // עדכון כל 5 שניות
});
</script>
{% endblock %}